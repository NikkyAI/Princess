import compiler
import codegen
import lexer
import util
import parser
import scope
import typechecking

def compile(s: string) -> string {
    codegen::outfolder = "./bin"

    let main = "main"
    let tokens = lexer::lex(s)
    let lines = util::split_lines(s)
    let node = parser::parse(tokens, lines, main, main)
    let scope = scope::enter_scope(builtins::builtins)
    typechecking::typecheck(node, scope, main, main)
    let result = compiler::compile(node, main, main)
    codegen::gen(result, main, main)
    
    let fh = open("./bin/main.ll", "r")
    seek(fh, 0, SEEK_END)
    let filesize = tell(fh)
    rewind(fh)
    let buf = allocate(char, filesize + 1)
    read(fh, buf, filesize)
    buf[filesize] = '\0'
    close(fh)

    return buf
}

def test_emit_arithmetic {
    print(">Test arithmetic instruction... ")

    var str = "
        10 + 10 + 10
    "
    var res = compile(str)

    assert(res == "add i32 10, 10\n")

    print("OK\n")
}

export def test {
    print("Running tests on Compiler...\n")
    test_emit_arithmetic()
}