import lexer
import buffer

def next_string(list: **lexer::TokenList) -> string {
    let value = (@@list).value
    assert(value.tpe == lexer::TokenType::STRING)
    @list = (@@list).next
    return @(value.value !*string)
}

def test_string_literal {
    var str = "\"this is a test\""
    var result = lexer::lex(str)
    assert(next_string(*result) == "this is a test")

    str = "\"test\" \"more\""
    result = lexer::lex(str)
    assert(next_string(*result) == "test")
    assert(next_string(*result) == "more")

    str = "\"\\b\\f\\n\\r\\t\\'\\\"\\\\\""
    result = lexer::lex(str)
    assert(next_string(*result) == "\b\f\n\r\t\'\"\\")
}

def test_lexer {
    test_string_literal()
}

def test_buffer {
    var str = "this is a test"
    var buf = buffer::make_buffer()
    buffer::append_str(*buf, str)
    var res = buffer::to_string(*buf)
    assert(res == str)
    free(res)
    buffer::append_char(*buf, 't')
    res = buffer::to_string(*buf)
    assert(res == "this is a testt")
    free(res)
}

export def run_test_suite {
    test_buffer()
    test_lexer()
}