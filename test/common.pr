import io
import process

#if defined WIN32 {
    // TODO Somehow on windows the dll doesn't inherit the mode
    cstd::_setmode(1, 0x8000)
    cstd::_setmode(2, 0x8000)
}

export def run_compiler(str: &string, args: &string) -> &string {
    let tmpsrc = tmpfolder("princess") + "/main.pr"

    let fh = open(tmpsrc, "w")
    fprint(fh, str)
    fh.close()

    let r, w = io::pipe()

    var compiler: &string = runtime::executable
    let env = cstd::getenv("PRINCESS_COMPILER".value)
    if env { compiler = make_string(env) }

    let proc = *process::spawn(
        compiler, 
        [tmpsrc, args] ![&string],
        stdout = w, stderr = io::stderr_orig
    )
    proc.wait()
    proc.dispose()

    if proc.exit_code {
        close(w)
        close(r)
        return null
    }

    fflush(w)
    close(w)
    let ast = r.read_all_pipe()
    close(r)
    return ast
}